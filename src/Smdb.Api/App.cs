namespace Smdb.Api;

using Abcs.Config;
using Abcs.Http;
using Smdb.Api.Movies;
using Smdb.Api.Genres;
using Smdb.Core.Movies;
using Smdb.Core.Genres;
using System.Net;

public class App : HttpServer
{
	public App()
	{
		
	}

	public override void Init()
	{
		var db = new MemoryDatabase();

		var movieRepo = new MemoryMovieRepository(db);
		var movieServ = new DefaultMovieService(movieRepo);
		var movieCtrl = new MoviesController(movieServ);
		var movieRouter = new MoviesRouter(movieCtrl);

		var genreRepo = new MemoryGenreRepository(db);
		var genreServ = new DefaultGenreService(genreRepo);
		var genreCtrl = new GenresController(genreServ);
		var genreRouter = new GenresRouter(genreCtrl);

		var apiRouter = new HttpRouter();

		router.Use(HttpUtils.StructuredLogging);
		router.Use(HttpUtils.CentralizedErrorHandling);
		router.Use(HttpUtils.ParseRequestUrl);
		router.Use(HttpUtils.ParseRequestQueryString);
		router.Use(HttpUtils.AddResponseCorsHeaders);
		router.UseParametrizedRouteMatching();
		router.UseDefaultResponse();

		router.UseRouter("/api/v1", apiRouter);
		apiRouter.UseRouter("/movies", movieRouter);
		apiRouter.UseRouter("/genres", genreRouter);
	}
}
